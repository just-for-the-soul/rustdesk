name: Build Android APK

on:
  workflow_dispatch:  # Ручной запуск
  push:
    branches: [ master ]

env:
  RUST_VERSION: "1.75"
  CARGO_NDK_VERSION: "3.1.2"
  FLUTTER_VERSION: "3.24.5"
  NDK_VERSION: "r27c"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"

jobs:
  build-android:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        targets: aarch64-linux-android
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
    
    - name: Setup NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: ${{ env.NDK_VERSION }}
    
    - name: Install cargo-ndk
      run: cargo install cargo-ndk --version ${{ env.CARGO_NDK_VERSION }}
    
    - name: Setup vcpkg
      run: |
        git clone https://github.com/microsoft/vcpkg
        cd vcpkg
        git checkout ${{ env.VCPKG_COMMIT_ID }}
        ./bootstrap-vcpkg.sh
        ./vcpkg install libvpx libyuv opus aom
        echo "VCPKG_ROOT=$PWD" >> $GITHUB_ENV
    
    - name: Install flutter_rust_bridge_codegen
      run: cargo install flutter_rust_bridge_codegen --version 1.80.1 --features uuid
    
    - name: Generate bridge files
      run: |
        flutter_rust_bridge_codegen \
          --rust-input src/flutter_ffi.rs \
          --dart-output flutter/lib/generated_bridge.dart \
          --c-output flutter/macos/Runner/bridge_generated.h
    
    - name: Build native library
      run: |
        cargo ndk \
          --target aarch64-linux-android \
          -o flutter/android/app/src/main/jniLibs \
          build \
          --release \
          --features flutter
    
    - name: Build APK
      run: |
        cd flutter
        flutter pub get
        flutter build apk --release --target-platform android-arm64
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-android-apk
        path: flutter/build/app/outputs/flutter-apk/*.apk
        retention-days: 7

