name: Build Android APK (Universal)

on:
  workflow_dispatch:
  push:
    branches: [ master ]

env:
  RUST_VERSION: "1.75"
  CARGO_NDK_VERSION: "3.1.2"
  FLUTTER_VERSION: "3.24.5"
  NDK_VERSION: "r27c"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"
  VERSION: "1.4.5"

jobs:
  build-android-universal:
    runs-on: ubuntu-24.04

    steps:
    - name: Free Disk Space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        android: false
        dotnet: true
        haskell: true
        large-packages: false
        docker-images: true
        swap-storage: false

    - name: Export GitHub Actions cache environment variables
      uses: actions/github-script@v6
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
             clang cmake curl gcc-multilib git g++ g++-multilib \
             libasound2-dev libc6-dev libclang-dev libgstreamer1.0-dev \
             libgstreamer-plugins-base1.0-dev libgtk-3-dev libpulse-dev \
             libxcb-randr0-dev libxcb-shape0-dev libxcb-xfixes0-dev \
             libxdo-dev libxfixes-dev llvm-dev nasm ninja-build \
             openjdk-17-jdk-headless pkg-config wget

    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: "stable"
        flutter-version: ${{ env.FLUTTER_VERSION }}

    - name: Patch Flutter
      run: |
        cd $(dirname $(dirname $(which flutter)))
        [[ "3.24.5" == "${{ env.FLUTTER_VERSION }}" ]] && git apply ${{ github.workspace }}/.github/patches/flutter_3.24.4_dropdown_menu_enableFilter.diff || true

    - name: Setup NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: ${{ env.NDK_VERSION }}
        add-to-path: true

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: /opt/artifacts/vcpkg
        vcpkgGitCommitId: ${{ env.VCPKG_COMMIT_ID }}
        doNotCache: false

    - name: Install vcpkg dependencies for arm64
      run: |
        if ! ./flutter/build_android_deps.sh "arm64-v8a"; then
          find "${VCPKG_ROOT}/" -name "*.log" | while read -r _1; do
            echo "$_1:"; cat "$_1"; echo "======"; done
          exit 1
        fi

    - name: Install vcpkg dependencies for armv7
      run: |
        if ! ./flutter/build_android_deps.sh "armeabi-v7a"; then
          find "${VCPKG_ROOT}/" -name "*.log" | while read -r _1; do
            echo "$_1:"; cat "$_1"; echo "======"; done
          exit 1
        fi

    - name: Install Rust (stable for tools)
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
        source $HOME/.cargo/env
        rustup install ${{ env.RUST_VERSION }}
        cargo install cargo-ndk --version ${{ env.CARGO_NDK_VERSION }} --locked
        cargo install flutter_rust_bridge_codegen --version 1.80.1 --features uuid

    - name: Generate bridge files
      run: |
        source $HOME/.cargo/env
        rustup default stable
        cd flutter
        flutter pub get
        cd ..
        flutter_rust_bridge_codegen \
          --rust-input src/flutter_ffi.rs \
          --dart-output flutter/lib/generated_bridge.dart \
          --c-output flutter/macos/Runner/bridge_generated.h

    - name: Build Rust library for arm64
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        source $HOME/.cargo/env
        rustup default ${{ env.RUST_VERSION }}
        rustup target add aarch64-linux-android
        
        # Собираем arm64
        ./flutter/ndk_arm64.sh
        
        # Копируем библиотеку arm64
        mkdir -p ./flutter/android/app/src/main/jniLibs/arm64-v8a
        cp ./target/aarch64-linux-android/release/liblibrustdesk.so \
           ./flutter/android/app/src/main/jniLibs/arm64-v8a/librustdesk.so
        
        # Копируем libc++_shared.so для arm64
        cp ${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/libc++_shared.so \
           ./flutter/android/app/src/main/jniLibs/arm64-v8a/

    - name: Build Rust library for armv7
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        source $HOME/.cargo/env
        rustup default ${{ env.RUST_VERSION }}
        rustup target add armv7-linux-androideabi
        
        # Собираем armv7
        ./flutter/ndk_arm.sh
        
        # Копируем библиотеку armv7
        mkdir -p ./flutter/android/app/src/main/jniLibs/armeabi-v7a
        cp ./target/armv7-linux-androideabi/release/liblibrustdesk.so \
           ./flutter/android/app/src/main/jniLibs/armeabi-v7a/librustdesk.so
        
        # Копируем libc++_shared.so для armv7
        cp ${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/arm-linux-androideabi/libc++_shared.so \
           ./flutter/android/app/src/main/jniLibs/armeabi-v7a/

    - name: Build Universal APK
      env:
        JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      run: |
        export PATH=/usr/lib/jvm/java-17-openjdk-amd64/bin:$PATH
        
        # Увеличиваем память Gradle
        sed -i "s/org.gradle.jvmargs=-Xmx1024M/org.gradle.jvmargs=-Xmx2g/g" ./flutter/android/gradle.properties
        
        # Используем debug signing (без секретов)
        sed -i "s/signingConfigs.release/signingConfigs.debug/g" ./flutter/android/app/build.gradle
        
        # Собираем универсальный APK (обе архитектуры в одном файле)
        cd flutter
        flutter pub get
        flutter build apk --release --target-platform android-arm64,android-arm
        
        # Переименовываем
        mkdir -p ../signed-apk
        mv build/app/outputs/flutter-apk/app-release.apk \
           ../signed-apk/rustdesk-${{ env.VERSION }}-universal.apk

    - name: Upload Universal APK
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: rustdesk-${{ env.VERSION }}-universal-apk
        path: signed-apk/*.apk
        retention-days: 7


